# How to use Bigloo with WASM backend

## How to compile Bigloo/WASM

  1. First, compile Bigloo in this repository (as usual).
  2. Make the WASM heap: `cd runtime && make heap-wasm`.
  3. Compile the WASM lib: `cd runtime && make lib-wasm -j`.
     This will create the files `bigloo_s.wat` and `bigloo_s.wasm` in the Bigloo lib directory.
  4. Install WASM lib and heap: `cd runtime && make install-wasm`

These requires the `bigloo-wasm-merge` tool and the `gen_dummy_wasm_imports` (found in `tools/gen_dummy_wasm_imports.scm`).

The Makefile may not perfectly works, you should probably directly build `gen_dummy_wasm_imports` and move the generated executable to `runtime/objs/wasm_s/gen_dummy_wasm_imports`.

## How to compile bigloo-wasm-merge

This is required to link the WASM files generated by Bigloo. In the future, this tool will be directly integrated inside Bigloo backend.

`cd tools && bigloo -O3 wasm-merge.scm -o bigloo-wasm-merge`

## How to compile foo.scm to WASM

You must first compile bigloo with the WASM backend and the WASM runtime library. You must also compile bigloo-wasm-merge in tools.

1. Generate the .wat file: `bigloo -wasm foo.scm -o foo.wat`.
2. Link the file to the Bigloo standard library: `bigloo-wasm-merge $LIBDIR/types.wat $LIBDIR/bigloo_s.wat foo.wat > foo.final.wat`.

where `$LIBDIR` is the directory where the WASM runtime library was installed. If you cannot find `$LIBDIR/types.wat`, then you can find the original copy at `runtime/Wlib/runtime.types`.

3. Assemble the file with `wasm-as`:
`wasm-as -all foo.final.wat -o foo.wasm`
4. This will create a `foo.wasm` file that can be executed on any supported WASM virtual machine.

Finally, lets run the code:
1. Using Node: `node $LIBDIR/runtime.mjs foo.wasm`.
2. Or using Deno: `deno run --allow-read $LIBDIR/runtime.mjs foo.wasm`.

You can also find `$LIBDIR/runtime.mjs` at `runtime/Wlib/runtime.mjs`.

You can specify `--inspect-wait` to Node or Deno to enable the Chrome Devtools debugger (go to [chrome://inspect] or something like that).

## TODO

+ Integrate `bigloo-wasm-merge` directly to the WASM backend
+ Implement JS regexes
+ Implement string input ports
+ Implement remaining date functions
+ Implement HTTP and sockets
+ Implement OS functions
+ Implement mmap
+ Implement what is missing in the runtime library (see [runtime/objs/wasm_s/dummy_runtime.wat] after compiling the runtime library)
+ Fix compilation bugs when compiling in safe mode some libraries
+ Fix runtime bugs in intext
+ See todos in the WASM backend code (in comptime and runtime folders)
+ Fix compilation of classes with mutual dependencies
+ Transform irreducible CFG to reducible ones for Relooper
+ Cleanup the WASM backend
+ Directly assemble WAT to binary WASM in the backend (to avoid dependency on external `wasm-as`)
+ Profile and optimize the generated WASM code
